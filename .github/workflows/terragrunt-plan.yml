name: Terragrunt Plan

on:
  workflow_dispatch:
    inputs:
      layer:
        description: '플랜할 레이어 (전체는 all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - 00-foundation
          - 04-iam
          - 05-cloudwatch
          - 10-networking
          - 20-security
          - 30-eks-cluster
          - 40-nodegroups
          - 50-addons
          - 55-argocd
          - 60-database
      environment:
        description: '환경'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.14.0'
  TG_VERSION: '0.96.0'
  TG_NON_INTERACTIVE: true

permissions:
  id-token: write
  contents: read

jobs:
  plan-all:
    name: Plan All Layers (순차)
    runs-on: ubuntu-latest
    environment: jsj_eks_prod
    if: ${{ inputs.layer == 'all' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Clean Terragrunt Cache
        run: |
          find environments/${{ inputs.environment }} -type d -name ".terragrunt-cache" -exec rm -rf {} + 2>/dev/null || true

      - name: Plan 00-foundation
        working-directory: environments/${{ inputs.environment }}/00-foundation
        run: |
          echo ">>> Planning 00-foundation..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 04-iam
        working-directory: environments/${{ inputs.environment }}/04-iam
        run: |
          echo ">>> Planning 04-iam..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 05-cloudwatch
        working-directory: environments/${{ inputs.environment }}/05-cloudwatch
        run: |
          echo ">>> Planning 05-cloudwatch..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 10-networking
        working-directory: environments/${{ inputs.environment }}/10-networking
        run: |
          echo ">>> Planning 10-networking..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 20-security
        working-directory: environments/${{ inputs.environment }}/20-security
        run: |
          echo ">>> Planning 20-security..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 30-eks-cluster
        working-directory: environments/${{ inputs.environment }}/30-eks-cluster
        run: |
          echo ">>> Planning 30-eks-cluster..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 40-nodegroups
        working-directory: environments/${{ inputs.environment }}/40-nodegroups
        run: |
          echo ">>> Planning 40-nodegroups..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 50-addons
        working-directory: environments/${{ inputs.environment }}/50-addons
        run: |
          echo ">>> Planning 50-addons..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 55-argocd
        working-directory: environments/${{ inputs.environment }}/55-argocd
        run: |
          echo ">>> Planning 55-argocd..."
          terragrunt run init
          terragrunt run -- plan

      - name: Plan 60-database
        working-directory: environments/${{ inputs.environment }}/60-database
        run: |
          echo ">>> Planning 60-database..."
          terragrunt run init
          terragrunt run -- plan

      - name: Post Plan Summary
        run: |
          echo "## Terragrunt Plan All Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Layers planned:** 00-foundation → 04-iam → 05-cloudwatch → 10-networking → 20-security → 30-eks-cluster → 40-nodegroups → 50-addons → 55-argocd → 60-database" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  plan-single:
    name: Plan Single Layer
    runs-on: ubuntu-latest
    environment: jsj_eks_prod
    if: ${{ inputs.layer != 'all' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Clean Terragrunt Cache
        run: |
          find environments/${{ inputs.environment }} -type d -name ".terragrunt-cache" -exec rm -rf {} + 2>/dev/null || true

      - name: Terragrunt Init
        working-directory: environments/${{ inputs.environment }}/${{ inputs.layer }}
        run: terragrunt run init

      - name: Terragrunt Plan
        working-directory: environments/${{ inputs.environment }}/${{ inputs.layer }}
        run: terragrunt run -- plan

      - name: Post Plan Summary
        run: |
          echo "## Terragrunt Plan Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Layer:** ${{ inputs.layer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
