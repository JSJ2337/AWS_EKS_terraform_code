name: Bootstrap State Backend

on:
  workflow_dispatch:
    inputs:
      action:
        description: '실행할 작업'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      region:
        description: 'AWS Region'
        required: true
        default: 'ap-northeast-2'
        type: string
      project:
        description: 'Project Name'
        required: true
        default: 'eks-prod'
        type: string
      environment:
        description: 'Environment Name'
        required: true
        default: 'prod'
        type: string
      confirm_destroy:
        description: 'Destroy 시 확인 (delete 입력)'
        required: false
        type: string

env:
  TF_VERSION: '1.14.0'

permissions:
  id-token: write
  contents: read

jobs:
  # =============================================================================
  # Plan Job - 항상 먼저 실행
  # =============================================================================
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: ${{ inputs.action != 'destroy' || inputs.confirm_destroy == 'delete' }}
    outputs:
      bucket_exists: ${{ steps.check_bucket.outputs.bucket_exists }}
    defaults:
      run:
        working-directory: bootstrap/00-state-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check if backend resources exist
        id: check_bucket
        run: |
          BUCKET_NAME="${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
          TABLE_NAME="${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"

          BUCKET_EXISTS=false
          TABLE_EXISTS=false

          # Check S3 bucket
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            BUCKET_EXISTS=true
            echo "S3 bucket '$BUCKET_NAME' exists."
          else
            echo "S3 bucket '$BUCKET_NAME' does not exist."
          fi

          # Check DynamoDB table
          if aws dynamodb describe-table --table-name "$TABLE_NAME" 2>/dev/null; then
            TABLE_EXISTS=true
            echo "DynamoDB table '$TABLE_NAME' exists."
          else
            echo "DynamoDB table '$TABLE_NAME' does not exist."
          fi

          # Both must exist to use S3 backend
          if [ "$BUCKET_EXISTS" == "true" ] && [ "$TABLE_EXISTS" == "true" ]; then
            echo "bucket_exists=true" >> $GITHUB_OUTPUT
            echo "Both S3 bucket and DynamoDB table exist. Using S3 backend."
          else
            echo "bucket_exists=false" >> $GITHUB_OUTPUT
            echo "Backend resources incomplete. Using local backend for creation."
          fi

      - name: Generate S3 backend config
        if: steps.check_bucket.outputs.bucket_exists == 'true'
        run: |
          cat > backend.tf << 'EOF'
          terraform {
            backend "s3" {
              bucket         = "${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
              key            = "bootstrap/00-state-backend/terraform.tfstate"
              region         = "${{ inputs.region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
            }
          }
          EOF
          echo "Generated S3 backend configuration:"
          cat backend.tf

      - name: Disable prevent_destroy for Destroy
        if: ${{ inputs.action == 'destroy' }}
        run: |
          echo "Disabling prevent_destroy lifecycle rules for destroy operation..."
          sed -i 's/prevent_destroy = true/prevent_destroy = false/g' main.tf

      - name: Terraform Init
        run: |
          if [ "${{ steps.check_bucket.outputs.bucket_exists }}" == "true" ]; then
            terraform init \
              -backend-config="bucket=${{ inputs.project }}-terraform-state-${{ inputs.environment }}" \
              -backend-config="key=bootstrap/00-state-backend/terraform.tfstate" \
              -backend-config="region=${{ inputs.region }}" \
              -backend-config="encrypt=true" \
              -backend-config="dynamodb_table=${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
          else
            terraform init
          fi

      - name: Terraform Plan
        id: plan
        run: |
          if [ "${{ inputs.action }}" == "destroy" ]; then
            terraform plan -destroy \
              -var="region=${{ inputs.region }}" \
              -var="project=${{ inputs.project }}" \
              -var="environment=${{ inputs.environment }}" 2>&1 | tee plan_output.txt
          else
            terraform plan \
              -var="region=${{ inputs.region }}" \
              -var="project=${{ inputs.project }}" \
              -var="environment=${{ inputs.environment }}" 2>&1 | tee plan_output.txt
          fi

      - name: Plan Summary
        run: |
          echo "## Terraform Plan - ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ inputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ steps.check_bucket.outputs.bucket_exists == 'true' && 'S3' || 'Local (initial)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Plan Output (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Approval Job - Apply/Destroy 전 승인 대기
  # =============================================================================
  approval:
    name: Waiting for Approval
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ inputs.action == 'apply' || (inputs.action == 'destroy' && inputs.confirm_destroy == 'delete') }}
    environment: jsj_eks_prod
    steps:
      - name: Approval Granted
        run: |
          echo "✅ Approval granted for ${{ inputs.action }} operation"
          echo "Proceeding with ${{ inputs.action }}..."

  # =============================================================================
  # Apply Job - Plan 다시 실행 후 Apply
  # =============================================================================
  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [plan, approval]
    if: ${{ inputs.action == 'apply' }}
    defaults:
      run:
        working-directory: bootstrap/00-state-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Generate S3 backend config
        if: needs.plan.outputs.bucket_exists == 'true'
        run: |
          cat > backend.tf << 'EOF'
          terraform {
            backend "s3" {
              bucket         = "${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
              key            = "bootstrap/00-state-backend/terraform.tfstate"
              region         = "${{ inputs.region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
            }
          }
          EOF

      - name: Terraform Init
        run: |
          if [ "${{ needs.plan.outputs.bucket_exists }}" == "true" ]; then
            terraform init \
              -backend-config="bucket=${{ inputs.project }}-terraform-state-${{ inputs.environment }}" \
              -backend-config="key=bootstrap/00-state-backend/terraform.tfstate" \
              -backend-config="region=${{ inputs.region }}" \
              -backend-config="encrypt=true" \
              -backend-config="dynamodb_table=${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
          else
            terraform init
          fi

      - name: Terraform Plan (Verify)
        run: |
          echo "Running plan to verify changes before apply..."
          terraform plan \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Migrate state to S3 (First time only)
        if: needs.plan.outputs.bucket_exists == 'false'
        run: |
          echo "Migrating local state to S3 backend..."

          cat > backend.tf << 'EOF'
          terraform {
            backend "s3" {
              bucket         = "${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
              key            = "bootstrap/00-state-backend/terraform.tfstate"
              region         = "${{ inputs.region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
            }
          }
          EOF

          terraform init -migrate-state -force-copy \
            -backend-config="bucket=${{ inputs.project }}-terraform-state-${{ inputs.environment }}" \
            -backend-config="key=bootstrap/00-state-backend/terraform.tfstate" \
            -backend-config="region=${{ inputs.region }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"

          echo "State migration completed successfully!"

      - name: Apply Summary
        run: |
          echo "## ✅ Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: \`${{ inputs.project }}-terraform-state-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table: \`${{ inputs.project }}-terraform-lock-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- State Key: \`bootstrap/00-state-backend/terraform.tfstate\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Destroy Job
  # =============================================================================
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: [plan, approval]
    if: ${{ inputs.action == 'destroy' && inputs.confirm_destroy == 'delete' }}
    defaults:
      run:
        working-directory: bootstrap/00-state-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Empty S3 bucket (delete all versions and delete markers)
        run: |
          BUCKET_NAME="${{ inputs.project }}-terraform-state-${{ inputs.environment }}"

          echo "Deleting all object versions from bucket: $BUCKET_NAME"

          # Delete all object versions
          aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json | \
            jq -r '.Versions[]? | "\(.Key)\t\(.VersionId)"' | \
            while IFS=$'\t' read -r key version_id; do
              if [ -n "$key" ] && [ -n "$version_id" ]; then
                echo "Deleting version: $key ($version_id)"
                aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version_id" || true
              fi
            done

          # Delete all delete markers
          echo "Deleting all delete markers..."
          aws s3api list-object-versions --bucket "$BUCKET_NAME" --output json | \
            jq -r '.DeleteMarkers[]? | "\(.Key)\t\(.VersionId)"' | \
            while IFS=$'\t' read -r key version_id; do
              if [ -n "$key" ] && [ -n "$version_id" ]; then
                echo "Deleting marker: $key ($version_id)"
                aws s3api delete-object --bucket "$BUCKET_NAME" --key "$key" --version-id "$version_id" || true
              fi
            done

          echo "Bucket emptied successfully!"

      - name: Disable prevent_destroy
        run: |
          sed -i 's/prevent_destroy = true/prevent_destroy = false/g' main.tf
          echo "Updated main.tf:"
          cat main.tf

      - name: Terraform Init (Local backend for destroy)
        run: |
          terraform init

      - name: Import existing resources to local state
        run: |
          echo "Importing existing resources to local state..."
          terraform import \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}" \
            aws_s3_bucket.terraform_state "${{ inputs.project }}-terraform-state-${{ inputs.environment }}" || true

          terraform import \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}" \
            aws_dynamodb_table.terraform_lock "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}" || true

      - name: Terraform Plan (Destroy)
        run: |
          echo "Running destroy plan to verify..."
          terraform plan -destroy \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Terraform Destroy
        run: |
          terraform destroy -auto-approve \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Destroy Summary
        run: |
          echo "## ⚠️ Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: \`${{ inputs.project }}-terraform-state-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table: \`${{ inputs.project }}-terraform-lock-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Reject Job - Destroy 확인 실패
  # =============================================================================
  reject:
    name: Destroy Rejected
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'destroy' && inputs.confirm_destroy != 'delete' }}
    steps:
      - name: Reject
        run: |
          echo "❌ Destroy rejected. 'delete' 입력이 필요합니다."
          exit 1
