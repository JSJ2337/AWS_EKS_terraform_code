name: Bootstrap State Backend

on:
  workflow_dispatch:
    inputs:
      action:
        description: '실행할 작업'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      region:
        description: 'AWS Region'
        required: true
        default: 'ap-northeast-2'
        type: string
      project:
        description: 'Project Name'
        required: true
        default: 'eks-prod'
        type: string
      environment:
        description: 'Environment Name'
        required: true
        default: 'prod'
        type: string
      confirm_destroy:
        description: 'Destroy 시 확인 (delete 입력)'
        required: false
        type: string

env:
  TF_VERSION: '1.14.0'

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    name: Bootstrap State Backend
    runs-on: ubuntu-latest
    environment: jsj_eks_prod
    if: ${{ inputs.action != 'destroy' || inputs.confirm_destroy == 'delete' }}
    defaults:
      run:
        working-directory: bootstrap/00-state-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.region }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check if S3 bucket exists
        id: check_bucket
        run: |
          BUCKET_NAME="${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "bucket_exists=true" >> $GITHUB_OUTPUT
            echo "S3 bucket '$BUCKET_NAME' exists. Using S3 backend."
          else
            echo "bucket_exists=false" >> $GITHUB_OUTPUT
            echo "S3 bucket '$BUCKET_NAME' does not exist. Using local backend for initial creation."
          fi

      - name: Generate S3 backend config
        if: steps.check_bucket.outputs.bucket_exists == 'true'
        run: |
          cat > backend.tf << 'EOF'
          terraform {
            backend "s3" {
              bucket         = "${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
              key            = "bootstrap/00-state-backend/terraform.tfstate"
              region         = "${{ inputs.region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
            }
          }
          EOF
          echo "Generated S3 backend configuration:"
          cat backend.tf

      - name: Terraform Init
        run: |
          if [ "${{ steps.check_bucket.outputs.bucket_exists }}" == "true" ]; then
            terraform init \
              -backend-config="bucket=${{ inputs.project }}-terraform-state-${{ inputs.environment }}" \
              -backend-config="key=bootstrap/00-state-backend/terraform.tfstate" \
              -backend-config="region=${{ inputs.region }}" \
              -backend-config="encrypt=true" \
              -backend-config="dynamodb_table=${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
          else
            terraform init
          fi

      - name: Terraform Plan
        if: ${{ inputs.action == 'plan' }}
        run: |
          terraform plan \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Terraform Apply
        if: ${{ inputs.action == 'apply' }}
        run: |
          terraform apply -auto-approve \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Migrate state to S3 (First time only)
        if: ${{ inputs.action == 'apply' && steps.check_bucket.outputs.bucket_exists == 'false' }}
        run: |
          echo "Migrating local state to S3 backend..."

          # Generate backend config
          cat > backend.tf << 'EOF'
          terraform {
            backend "s3" {
              bucket         = "${{ inputs.project }}-terraform-state-${{ inputs.environment }}"
              key            = "bootstrap/00-state-backend/terraform.tfstate"
              region         = "${{ inputs.region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"
            }
          }
          EOF

          # Re-init with S3 backend and migrate state
          terraform init -migrate-state -force-copy \
            -backend-config="bucket=${{ inputs.project }}-terraform-state-${{ inputs.environment }}" \
            -backend-config="key=bootstrap/00-state-backend/terraform.tfstate" \
            -backend-config="region=${{ inputs.region }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ inputs.project }}-terraform-lock-${{ inputs.environment }}"

          echo "State migration completed successfully!"

      - name: Disable prevent_destroy for Destroy
        if: ${{ inputs.action == 'destroy' && inputs.confirm_destroy == 'delete' }}
        run: |
          echo "Disabling prevent_destroy lifecycle rules for destroy operation..."
          sed -i 's/prevent_destroy = true/prevent_destroy = false/g' main.tf
          echo "Updated main.tf:"
          grep -n "prevent_destroy" main.tf

      - name: Terraform Destroy
        if: ${{ inputs.action == 'destroy' && inputs.confirm_destroy == 'delete' }}
        run: |
          # Migrate state to local before destroying (S3 will be deleted)
          echo "Migrating state from S3 to local before destroy..."
          rm -f backend.tf
          terraform init -migrate-state -force-copy

          terraform destroy -auto-approve \
            -var="region=${{ inputs.region }}" \
            -var="project=${{ inputs.project }}" \
            -var="environment=${{ inputs.environment }}"

      - name: Post Summary
        run: |
          echo "## Bootstrap State Backend - ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ inputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ steps.check_bucket.outputs.bucket_exists == 'true' && 'S3' || 'Local → S3 (migrated)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.action }}" == "apply" ]; then
            echo "### Resources" >> $GITHUB_STEP_SUMMARY
            echo "- S3 Bucket: \`${{ inputs.project }}-terraform-state-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- DynamoDB Table: \`${{ inputs.project }}-terraform-lock-${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- State Key: \`bootstrap/00-state-backend/terraform.tfstate\`" >> $GITHUB_STEP_SUMMARY
          fi

  reject:
    name: Destroy Rejected
    runs-on: ubuntu-latest
    if: ${{ inputs.action == 'destroy' && inputs.confirm_destroy != 'delete' }}
    steps:
      - name: Reject
        run: |
          echo "Destroy rejected. 'delete' 입력이 필요합니다."
          exit 1
