name: Terragrunt Destroy

on:
  workflow_dispatch:
    inputs:
      layer:
        description: '삭제할 레이어'
        required: true
        type: choice
        options:
          - all
          - 60-database
          - 56-vpc-lattice
          - 55-argocd
          - 50-addons
          - 45-ecr
          - 40-fargate
          - 30-eks-cluster
          - 20-security
          - 10-networking
          - 05-cloudwatch
          - 04-iam
          - 00-foundation
      environment:
        description: '환경'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
      confirm:
        description: '삭제 확인 (delete 입력)'
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.14.0'
  TG_VERSION: '0.96.0'
  TG_NON_INTERACTIVE: true

permissions:
  id-token: write
  contents: read

jobs:
  destroy-all:
    name: Destroy All Layers (역순)
    runs-on: ubuntu-latest
    environment: jsj_eks_prod
    if: ${{ inputs.confirm == 'delete' && inputs.layer == 'all' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Destroy 60-database
        working-directory: environments/${{ inputs.environment }}/60-database
        run: |
          echo ">>> Destroying 60-database..."
          terragrunt run init || true
          terragrunt run -- destroy -auto-approve || echo "60-database not found or already destroyed"

      - name: Destroy 56-vpc-lattice
        working-directory: environments/${{ inputs.environment }}/56-vpc-lattice
        run: |
          echo ">>> Destroying 56-vpc-lattice..."
          terragrunt run init || true
          terragrunt run -- destroy -auto-approve || echo "56-vpc-lattice not found or already destroyed"

      - name: Destroy 55-argocd
        working-directory: environments/${{ inputs.environment }}/55-argocd
        run: |
          echo ">>> Destroying 55-argocd..."
          terragrunt run init || true
          terragrunt run -- destroy -auto-approve || echo "55-argocd not found or already destroyed"

      - name: Destroy 50-addons
        working-directory: environments/${{ inputs.environment }}/50-addons
        run: |
          echo ">>> Destroying 50-addons..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 45-ecr
        working-directory: environments/${{ inputs.environment }}/45-ecr
        run: |
          echo ">>> Destroying 45-ecr..."
          terragrunt run init || true
          terragrunt run -- destroy -auto-approve || echo "45-ecr not found or already destroyed"

      - name: Destroy 40-fargate
        working-directory: environments/${{ inputs.environment }}/40-fargate
        run: |
          echo ">>> Destroying 40-fargate..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 30-eks-cluster
        working-directory: environments/${{ inputs.environment }}/30-eks-cluster
        run: |
          echo ">>> Destroying 30-eks-cluster..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 20-security
        working-directory: environments/${{ inputs.environment }}/20-security
        run: |
          echo ">>> Destroying 20-security..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 10-networking
        working-directory: environments/${{ inputs.environment }}/10-networking
        run: |
          echo ">>> Destroying 10-networking..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 05-cloudwatch
        working-directory: environments/${{ inputs.environment }}/05-cloudwatch
        run: |
          echo ">>> Destroying 05-cloudwatch..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 04-iam
        working-directory: environments/${{ inputs.environment }}/04-iam
        run: |
          echo ">>> Destroying 04-iam..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Destroy 00-foundation
        working-directory: environments/${{ inputs.environment }}/00-foundation
        run: |
          echo ">>> Destroying 00-foundation..."
          terragrunt run init
          terragrunt run -- destroy -auto-approve

      - name: Post Destroy Summary
        run: |
          echo "## Terragrunt Destroy All Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Layers destroyed:** 60-database → 56-vpc-lattice → 55-argocd → 50-addons → 45-ecr → 40-fargate → 30-eks-cluster → 20-security → 10-networking → 05-cloudwatch → 04-iam → 00-foundation" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  destroy-single:
    name: Destroy Single Layer
    runs-on: ubuntu-latest
    environment: jsj_eks_prod
    if: ${{ inputs.confirm == 'delete' && inputs.layer != 'all' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TG_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Terragrunt Init
        working-directory: environments/${{ inputs.environment }}/${{ inputs.layer }}
        run: terragrunt run init

      - name: Terragrunt Destroy
        working-directory: environments/${{ inputs.environment }}/${{ inputs.layer }}
        run: terragrunt run -- destroy -auto-approve

      - name: Post Destroy Summary
        run: |
          echo "## Terragrunt Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Layer:** ${{ inputs.layer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  reject:
    name: Destroy Rejected
    runs-on: ubuntu-latest
    if: ${{ inputs.confirm != 'delete' }}
    steps:
      - name: Reject
        run: |
          echo "Destroy rejected. 'delete' 입력이 필요합니다."
          exit 1
