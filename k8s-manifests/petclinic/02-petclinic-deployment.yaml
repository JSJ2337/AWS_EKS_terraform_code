################################################################################
# MySQL Client Test Pod (DB 연결 테스트용)
################################################################################
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-client
  namespace: petclinic
  labels:
    app: mysql-client
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-client
  template:
    metadata:
      labels:
        app: mysql-client
        tier: backend
    spec:
      containers:
        - name: mysql-client
          image: mysql:8.0
          command: ["sleep", "infinity"]
          env:
            - name: MYSQL_HOST
              valueFrom:
                secretKeyRef:
                  name: aurora-credentials
                  key: MYSQL_HOST
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: aurora-credentials
                  key: MYSQL_USER
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: aurora-credentials
                  key: MYSQL_PASSWORD
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: aurora-credentials
                  key: MYSQL_DATABASE
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
---
################################################################################
# Simple Web App (Nginx with DB info page)
################################################################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-app-config
  namespace: petclinic
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>3-Tier Architecture Demo</title>
        <style>
            body {
                font-family: 'Segoe UI', Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                color: white;
            }
            .container {
                text-align: center;
                padding: 40px;
                background: rgba(255,255,255,0.1);
                border-radius: 20px;
                backdrop-filter: blur(10px);
                max-width: 600px;
            }
            h1 { font-size: 2.5em; margin-bottom: 20px; }
            .tier {
                background: rgba(255,255,255,0.2);
                padding: 15px;
                margin: 10px 0;
                border-radius: 10px;
                text-align: left;
            }
            .tier h3 { margin: 0 0 10px 0; color: #ffd700; }
            .tier p { margin: 5px 0; font-size: 0.9em; }
            .status { color: #00ff88; }
            .arrow { font-size: 2em; color: #ffd700; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>3-Tier Architecture</h1>
            <h2>JSJ EKS Demo</h2>

            <div class="tier">
                <h3>Web Tier (Nginx)</h3>
                <p>Status: <span class="status">Running</span></p>
                <p>Role: Reverse Proxy, Load Balancing</p>
            </div>

            <div class="arrow">&#8595;</div>

            <div class="tier">
                <h3>Application Tier</h3>
                <p>Status: <span class="status">Running</span></p>
                <p>Role: Business Logic</p>
            </div>

            <div class="arrow">&#8595;</div>

            <div class="tier">
                <h3>Database Tier (Aurora MySQL)</h3>
                <p>Cluster: jsj-eks-aurora-mysql</p>
                <p>Writer: ap-northeast-2a</p>
                <p>Reader: ap-northeast-2c</p>
                <p>Status: <span class="status">Available</span></p>
            </div>
        </div>
    </body>
    </html>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
  namespace: petclinic
  labels:
    app: web-app
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
        tier: backend
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - containerPort: 80
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html/index.html
              subPath: index.html
      volumes:
        - name: html
          configMap:
            name: web-app-config
---
apiVersion: v1
kind: Service
metadata:
  name: petclinic-service
  namespace: petclinic
spec:
  type: ClusterIP
  selector:
    app: web-app
  ports:
    - name: http
      port: 8080
      targetPort: 80
      protocol: TCP
