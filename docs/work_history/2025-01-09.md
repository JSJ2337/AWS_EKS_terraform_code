# 작업 이력 - 2025-01-09

## 21:00 - AWS Load Balancer Controller 및 ArgoCD ALB Ingress 구성

### 변경 사항

#### 1. AWS Load Balancer Controller IAM 정책 업데이트

- 변경된 파일: `modules/addons/policies/aws-load-balancer-controller-policy.json`
- 변경 내용: `elasticloadbalancing:DescribeListenerAttributes` 권한 추가
- 이유: ALB Controller v2.7+ 버전에서 해당 권한이 필수로 요구됨

#### 2. Terragrunt Fargate Dependency 경고 해결

- 변경된 파일:
  - `environments/prod/50-addons/terragrunt.hcl`
  - `environments/prod/55-argocd/terragrunt.hcl`
- 변경 내용: `dependency` 블록 + `skip_outputs = true` → `dependencies` 블록으로 변경
- 이유: outputs이 없는 dependency에서 발생하는 경고 메시지 제거

```hcl
# 변경 전 (경고 발생)
dependency "fargate" {
  config_path  = "../40-fargate"
  skip_outputs = true
}

# 변경 후 (경고 없음)
dependencies {
  paths = ["../40-fargate"]
}
```

#### 3. AWS Region Deprecated 속성 수정

- 변경된 파일: `modules/addons/main.tf`
- 변경 내용: `data.aws_region.current.name` → `data.aws_region.current.id`
- 이유: AWS Provider 5.x에서 `name` 속성 deprecated

#### 4. ArgoCD Ingress를 Terraform으로 직접 관리

- 변경된 파일:
  - `modules/argocd/main.tf`: Helm Ingress 비활성화, kubernetes_ingress_v1 리소스 추가
  - `modules/argocd/outputs.tf`: ingress_enabled, ingress_name 출력 추가
  - `environments/prod/common.hcl`: ingress_hosts 설정 추가
  - `environments/prod/55-argocd/terragrunt.hcl`: ingress_hosts 입력 추가
- 변경 내용:
  - ArgoCD Helm 차트의 Ingress는 host 기본값(`argocd.example.com`) 강제 설정 문제
  - Terraform `kubernetes_ingress_v1` 리소스로 직접 생성하여 Host 조건 없이 ALB URL 직접 접속 허용
- 이유: ALB URL로 직접 브라우저 접속 가능하도록 개선

```hcl
# modules/argocd/main.tf - 새로 추가된 Ingress 리소스
resource "kubernetes_ingress_v1" "argocd_server" {
  count = var.ingress_enabled ? 1 : 0

  metadata {
    name        = "${var.release_name}-server"
    namespace   = var.namespace
    annotations = var.ingress_annotations
  }

  spec {
    ingress_class_name = var.ingress_class_name

    # Host 조건 없이 path만 설정 - 모든 호스트에서 접근 가능
    rule {
      http {
        path {
          path      = "/"
          path_type = "Prefix"
          backend {
            service {
              name = "${var.release_name}-server"
              port {
                number = 80
              }
            }
          }
        }
      }
    }
  }
}
```

### 영향도

- 영향받는 컴포넌트: addons 모듈, argocd 모듈, 55-argocd 레이어
- 배포 결과:
  - AWS Load Balancer Controller: 정상 동작
  - ArgoCD: ALB를 통해 외부 접속 가능
  - Ingress HOSTS: `*` (모든 호스트 허용)

---

## 20:30 - GitHub CLI 설치 및 워크플로우 자동화

### 변경 사항

- 설치 도구: `brew install gh`
- 인증: `gh auth login` 완료
- 용도: GitHub Actions 워크플로우를 CLI에서 직접 트리거

```bash
# 워크플로우 트리거 명령어
gh workflow run terragrunt-apply.yml -f layer=50-addons -f environment=prod
```

### 영향도

- 영향받는 컴포넌트: 로컬 개발 환경
- 주의사항: 없음

---

## 현재 인프라 상태

### ArgoCD 접속 정보

| 항목 | 값 |
| ---- | -- |
| URL | `http://k8s-argocd-argocdse-f62d13c9c8-1672707843.ap-northeast-2.elb.amazonaws.com/` |
| Username | `admin` |
| Password | Secret에서 조회 필요 |

```bash
# 패스워드 조회 명령어
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

### 배포된 리소스 현황

| 리소스 | 이름 | 상태 |
| ------ | ---- | ---- |
| ALB Ingress Controller | aws-load-balancer-controller | Running |
| ArgoCD Server | argocd-server | Running |
| ArgoCD Ingress | argocd-server (HOSTS: *) | Active |
| Application Load Balancer | k8s-argocd-argocdse-* | Active |

---

## 해결된 이슈

### 1. Fargate Dependency Warning

```text
# 에러 메시지
WARN Config ../40-fargate/terragrunt.hcl is a dependency of ./terragrunt.hcl that has no outputs

# 해결: dependency → dependencies 블록 변경
```

### 2. ALB Controller IAM Permission Denied

```text
# 에러 메시지
elasticloadbalancing:DescribeListenerAttributes action not authorized

# 해결: IAM 정책에 권한 추가
```

### 3. ArgoCD Ingress Host 조건 문제

```text
# 문제: Helm 차트가 기본값 argocd.example.com 강제 설정
# 해결: Terraform kubernetes_ingress_v1로 직접 생성, Host 조건 제거
```

---

## 커밋 이력

| 커밋 | 메시지 |
| ---- | ------ |
| 4049e2c | fix: ALB Controller IAM 정책에 DescribeListenerAttributes 권한 추가 |
| 24d6dac | fix: aws_region deprecated warning 수정 - name → id 변경 |
| 4fcac34 | fix: Fargate dependency 경고 메시지 제거 |
| 04cd760 | fix: ArgoCD Ingress Host 조건 제거 - ALB URL 직접 접속 허용 |
| 8122329 | fix: ArgoCD Ingress hosts 조건부 처리 - 빈 값이면 모든 호스트 허용 |
| 97393c7 | refactor: ArgoCD Ingress를 Terraform으로 직접 관리 - Host 조건 없이 ALB URL 직접 접속 |

---

## 다음 작업 예정

- ArgoCD Application 배포 테스트
- HTTPS 인증서 적용 (ACM + ALB)
- ArgoCD RBAC 설정
- GitOps 파이프라인 구성
