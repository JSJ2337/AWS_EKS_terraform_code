# 작업 이력 - 2025-01-07

## 14:00 - ArgoCD Terraform 모듈 및 55-argocd 레이어 생성

### 변경 사항

- 신규 파일: `modules/argocd/main.tf`
  - Helm Provider를 사용한 ArgoCD 설치
  - Kubernetes Namespace 생성
  - ArgoCD Helm Release 리소스

- 신규 파일: `modules/argocd/variables.tf`
  - 차트 버전, Namespace 설정
  - Server/Controller/Repo Server Replicas
  - Ingress, SSO (Dex), Notifications 설정
  - Resource limits 설정

- 신규 파일: `modules/argocd/outputs.tf`
  - Namespace, Release name, Server URL 출력

- 신규 파일: `modules/argocd/versions.tf`
  - Helm, Kubernetes Provider 버전 요구사항

- 신규 파일: `environments/prod/55-argocd/terragrunt.hcl`
  - EKS 클러스터, Node Group 의존성
  - Helm/Kubernetes Provider 동적 생성
  - common.hcl에서 ArgoCD 설정 참조

- 수정 파일: `environments/prod/common.hcl`
  - ArgoCD 설정 블록 추가
  - chart_version, replicas, 기능 토글

- 수정 파일: `.github/workflows/terragrunt-apply.yml`
  - 55-argocd 레이어 추가

- 수정 파일: `.github/workflows/terragrunt-destroy.yml`
  - 55-argocd 레이어 추가
  - 삭제 순서 업데이트

- 수정 파일: `docs/README.md`
  - 디렉토리 구조에 argocd 모듈 및 55-argocd 레이어 추가
  - 삭제 순서 업데이트

- 수정 파일: `docs/architecture.md`
  - 레이어 배포 다이어그램 업데이트 (ArgoCD → Istio/Apps)
  - 레이어별 설명 테이블에 55-argocd 추가

### 설계 결정

ArgoCD만 Terraform으로 설치하고, 이후 K8s 워크로드(Istio, Helm 차트, 애플리케이션)는
ArgoCD App of Apps 패턴으로 관리하는 것이 베스트 프랙티스

```text
Terraform 영역                ArgoCD 영역 (GitOps)
─────────────                ──────────────────
• VPC, EKS, RDS              • Istio
• IAM Roles (IRSA)           • cert-manager
• ArgoCD 설치 ──────────────► • aws-lb-controller
                             • 애플리케이션들
```

### 배포 순서

```text
00-foundation → 05-cloudwatch → 10-networking → 20-security → 30-eks-cluster → 40-nodegroups → 50-addons → 55-argocd → 60-database
```

### 삭제 순서

```text
60-database → 55-argocd → 50-addons → 40-nodegroups → 30-eks-cluster → 20-security → 10-networking → 05-cloudwatch → 00-foundation
```

### 다음 단계

1. EKS 클러스터 배포 후 55-argocd 레이어 적용
2. ArgoCD UI 접속 확인
3. App of Apps 패턴으로 Istio, cert-manager 등 설치

---

## 18:30 - IAM 전용 모듈 및 04-iam 레이어 생성

### 작업 배경

기존에 IAM 리소스가 여러 모듈에 분산되어 있어 관리가 어려움:

- `foundation`: eks_admin_role
- `security`: eks_cluster_role, eks_nodes_role
- `networking`: flow_logs_role
- `addons`: ebs_csi_role, aws_lb_controller_role, cluster_autoscaler_role
- `aurora-mysql`: rds_monitoring_role

### 파일 변경 내역

#### 신규 파일

- `modules/iam/main.tf`: IAM roles 정의
  - eks_admin_role
  - eks_cluster_role
  - eks_nodes_role
  - flow_logs_role
  - rds_monitoring_role

- `modules/iam/irsa.tf`: IRSA roles 정의
  - ebs_csi_role
  - aws_lb_controller_role
  - cluster_autoscaler_role

- `modules/iam/variables.tf`: 입력 변수
- `modules/iam/outputs.tf`: 출력값
- `modules/iam/versions.tf`: 프로바이더 버전
- `modules/iam/policies/aws-lb-controller-policy.json`: LB Controller IAM 정책

- `environments/prod/04-iam/terragrunt.hcl`: IAM 레이어

#### 수정 파일

- `modules/security/main.tf`:
  - IAM role 생성 조건부 처리 (`create_iam_roles` 변수)
  - 외부 IAM role ARN/name 참조 가능하도록 수정

- `modules/security/variables.tf`:
  - `create_iam_roles`, `eks_cluster_role_arn`, `eks_node_role_arn` 등 추가

- `modules/security/outputs.tf`:
  - locals 블록으로 내부/외부 role 참조 분기 처리

- `modules/networking/main.tf`:
  - flow_logs IAM role 생성 조건부 처리
  - 외부 role ARN 참조 가능하도록 수정

- `modules/networking/variables.tf`:
  - `create_flow_logs_iam_role`, `flow_logs_role_arn` 추가

- `environments/prod/10-networking/terragrunt.hcl`:
  - 04-iam 의존성 추가
  - flow_logs_role_arn 참조

- `environments/prod/20-security/terragrunt.hcl`:
  - 04-iam 의존성 추가
  - eks_cluster_role, eks_node_role ARN/name 참조

### 새로운 레이어 구조

```text
00-foundation
04-iam        ← 신규 (IAM 역할 통합)
05-cloudwatch
10-networking ← 04-iam 의존
20-security   ← 04-iam 의존
30-eks-cluster
40-nodegroups
50-addons
55-argocd
60-database
```

### IAM 레이어 설계 결정

1. **04로 배치한 이유**: 다른 모든 레이어가 IAM role을 참조할 수 있도록 가장 앞쪽에 배치
2. **조건부 생성**: 기존 모듈에서 `create_iam_roles=false` 설정 시 외부 role 참조
3. **IRSA 분리**: EKS OIDC Provider 생성 후 별도로 IRSA roles 활성화 가능

### IAM 레이어 영향도

- 신규 배포 시 04-iam 레이어 먼저 적용 필요
- 기존 인프라 마이그레이션 시 state 이동 필요할 수 있음
- GitHub Actions 워크플로우에 04-iam 레이어 추가 필요

---

## 19:00 - IRSA 관련 코드 정리

### IRSA 정리 내역

IRSA roles는 EKS OIDC Provider가 필요하므로 04-iam에서 생성 불가.
기존 50-addons 레이어에서 계속 관리하도록 결정.

#### 삭제된 파일

- `modules/iam/irsa.tf`: IRSA roles 정의 파일
- `modules/iam/policies/aws-lb-controller-policy.json`: LB Controller IAM 정책
- `modules/iam/versions.tf`: Terragrunt root.hcl에서 생성하므로 불필요

#### 수정된 파일

- `modules/iam/variables.tf`:
  - IRSA 관련 변수 삭제 (oidc_provider_arn, oidc_provider_url)
  - IRSA role 생성 플래그 삭제 (create_ebs_csi_role, create_lb_controller_role, create_cluster_autoscaler_role)

- `modules/iam/outputs.tf`:
  - IRSA 관련 출력값 삭제 (ebs_csi_role_arn/name, aws_lb_controller_role_arn/name, cluster_autoscaler_role_arn/name)

- `environments/prod/04-iam/terragrunt.hcl`:
  - IRSA 관련 입력값 삭제

### IRSA 분리 결정

```text
04-iam 모듈 (OIDC Provider 없음)     50-addons 모듈 (OIDC Provider 있음)
────────────────────────────────    ─────────────────────────────────
• eks_admin_role                    • ebs_csi_role (IRSA)
• eks_cluster_role                  • aws_lb_controller_role (IRSA)
• eks_nodes_role                    • cluster_autoscaler_role (IRSA)
• flow_logs_role
• rds_monitoring_role
```

### 최종 04-iam 모듈 역할 목록

| 역할 | 목적 | 변수 |
| ---- | ---- | ---- |
| eks_admin_role | EKS 관리자 접근 | create_eks_admin_role |
| eks_cluster_role | EKS 컨트롤 플레인 | create_eks_cluster_role |
| eks_nodes_role | EKS 워커 노드 | create_eks_node_role |
| flow_logs_role | VPC Flow Logs | create_flow_logs_role |
| rds_monitoring_role | RDS Enhanced Monitoring | create_rds_monitoring_role |

---

## 19:30 - IAM Role 이름 불일치 수정

### IAM Role 이름 문제

04-iam 모듈과 기존 security 모듈의 IAM role 이름이 달라서 EKS 클러스터가 재생성되려는 문제 발생.

| 모듈 | eks_cluster_role 이름 | eks_nodes_role 이름 |
| ---- | --------------------- | ------------------- |
| security (기존) | `${project}-eks-cluster-role-${env}` | `${project}-eks-nodes-role-${env}` |
| iam (수정 전) | `${project}-eks-cluster-${env}` | `${project}-eks-nodes-${env}` |

### IAM Role 이름 수정

`modules/iam/main.tf`에서 role 이름을 기존 security 모듈과 일치하도록 수정:

- `eks_cluster`: `jsj-eks-eks-cluster-role-prod`
- `eks_nodes`: `jsj-eks-eks-nodes-role-prod`

---

## 19:45 - deprecated 경고 수정

### aws_region.name deprecated 경고

```text
Warning: Deprecated attribute
  on main.tf line 48, in resource "aws_kms_key" "eks":
  48:   Service = "logs.${data.aws_region.current.name}.amazonaws.com"
The attribute "name" is deprecated.
```

### aws_region 속성 수정

`modules/foundation/main.tf`에서 `data.aws_region.current.name` → `data.aws_region.current.id`로 변경.

AWS Provider 5.x에서 `aws_region` data source의 `name` 속성이 deprecated 됨.

---

## 20:00 - IAM state 마이그레이션 워크플로우 추가

### 마이그레이션 워크플로우 신규 파일

- `.github/workflows/iam-migration.yml`: 3단계 마이그레이션 워크플로우
  - step1-remove-from-old-state: foundation, networking에서 IAM state 제거
  - step2-import-to-iam: 04-iam으로 import
  - step3-verify: 변경사항 검증

### 마이그레이션 관련 수정 파일

- `environments/prod/00-foundation/terragrunt.hcl`:
  - `create_eks_admin_role = false`로 변경 (04-iam으로 이동)
